

```python
import numpy as np
import pandas as pd
```


```python
# 读取一个以tab键为分隔符的文件，然后将每行内容保存成一组浮点数,其中\t转义字符表示为tab四个空格
def loaddataset(filename):
    # 定义一个空列表
    datamat = []
    # 打开一个filename文件
    fr = open(filename)
    # readlines() 方法用于读取所有行(直到结束符 EOF)并返回列表，该列表可以由 Python 的 for... in ... 结构进行处理。
    # 如果碰到结束符 EOF 则返回空字符串。
    for line in fr.readlines():
        # strip() 方法用于移除字符串头尾指定的字符（默认为空格或换行符）
        # split() 通过指定分隔符对字符串进行分割切片
        curline = line.strip().split('\t')
        # map() 会根据提供的函数对指定序列做映射,python2.0和3.0版本在返回结果上有差异，这里是指对curline做float操作并返回结果
        fltline = list(map(float,curline))
        # 将结果添加到原来的空列表中去
        datamat.append(fltline)
    return datamat
```


```python
# 机器学习实战的代码是基于python2，这里是基于python3,因此代码有细微差异
# 定义函数和三个参数，数据集、待切分的特征、该特征的某个值
# 该函数将通过数组过滤的方式对数据集切分得到两个子集并返回结果
def binsplitdataset(dataset, feature, value):
    # nonzero是numpy中用于得到数组array中非零元素的位置（数组索引）的函数
    mat0 = dataset[np.nonzero(dataset[:, feature] > value)[0],:]
    mat1 = dataset[np.nonzero(dataset[:, feature] <= value)[0],:]
    return mat0,mat1
```


```python
# np.eye生成对角矩阵
testmat = np.mat(np.eye(4))
```


```python
testmat
```




    matrix([[1., 0., 0., 0.],
            [0., 1., 0., 0.],
            [0., 0., 1., 0.],
            [0., 0., 0., 1.]])




```python
mat0, mat1 = binsplitdataset(testmat,1,0.5)
```


```python
print('---展示按照某个特征的大于阈值部分切片的矩阵第一部分---')
print(mat0)
print('---展示按照某个特征的小于等于阈值部分切片的矩阵第二部分---')
print(mat1)
```

    ---展示按照某个特征的大于阈值部分切片的矩阵第一部分---
    [[0. 1. 0. 0.]]
    ---展示按照某个特征的小于等于阈值部分切片的矩阵第二部分---
    [[1. 0. 0. 0.]
     [0. 0. 1. 0.]
     [0. 0. 0. 1.]]
    


```python
# 对数据集取出目标变量列，同时对目标变量求均值，比如上述的案例的对焦矩阵中，目标变量是最后一列，求均值等于0.25
def regleaf(dataset):
    return np.mean(dataset[:,-1])
```


```python
def regerr(dataset):
    # np.var函数是求方差，方差是指所有数与数组均值之差的平方和的均值，方差表达的是数组内的数的差异度
    # 这里表达的是目标变量的方差乘以数据集的样本个数（即行数），返回的是总方差
    # 实际含义为计算目标变量的平方误差
    return np.var(dataset[:,-1]) * np.shape(dataset)[0]
```


```python
# 定义函数来求数据的目标变量的均值，目标变量的平方误差，同时定义一个列表来控制函数停止的时机
def chooseBestSplit(dataset, leaftype=regleaf, errtype=regerr, ops=(1,4)):
    # 使用两个变量来作为控制阈值，tolS是允许的误差下降值，tolN是切分的最少样本数
    tolS=ops[0]; tolN=ops[1]
    # 先将目标变量转置为一个列表,然后选取这个列表中的不重复的元素组合成为一个元组,然后计算这个元祖的元素数量并判断是否唯一
    if len(set(dataset[:,-1].T.tolist()[0])) == 1:
        # 在Python中，有一个特殊的表示，None，它就是空
        # 如果所有目标变量的值都相等，那就不用预测了，退出，那么返回空值，并直接计算目标变量的均值
        return None, leaftype(dataset)
    # 计算数据集的行数和列数，行数代表数据集大小，列数代表特征值数量和目标变量的和
    m,n = np.shape(dataset)
    # 计算数据的平方误差
    S = errtype(dataset)
    # 定义bestS初始化为正无穷，这一步在初始化
    bestS = np.inf; bestIndex = 0; bestValue = 0
    # 遍历所有特征，这里n-1就是所有的特征数量
    # 对每一个特征
    for featIndex in range(n-1):
        # 对每一个特征里面的特征值
        for splitVal in set((dataset[:,featIndex].T.A.tolist())[0]):
            # 通过数据集的特征和特征值来对数据进行切分
            mat0,mat1 = binsplitdataset(dataset, featIndex, splitVal)
            # continue 语句用来告诉Python跳过当前循环的剩余语句，然后继续进行下一轮循环
            if (np.shape(mat0)[0] < tolN) or (np.shape(mat1)[0] < tolN):continue
            # 计算切分的两个单元分别的平方误差和
            newS=errtype(mat0) + errtype(mat1)
            # 更新平方误差值，并更新前期初始化的值为新的特征和新的特征值
            if newS < bestS:
                bestIndex = featIndex
                bestValue = splitVal
                bestS = newS
    # 假如数据的误差减小量低于阈值，则退出，并计算数据集的目标变量的均值
    if (S-bestS) < tolS:
        return None, leaftype(dataset)
     # 通过数据集的当前的特征和特征值来对数据进行切分
    mat0, mat1 = binsplitdataset(dataset, bestIndex, bestValue)
    # 如果切分出的数据集很小且低于阈值，则退出，并计算数据集的目标变量的均值
    if (np.shape(mat0)[0]< tolN) or (np.shape(mat1)[0]< tolN):
        return None, leaftype(dataset)
    # 返回最佳的切分特征和最佳的切分特征值
    return bestIndex,bestValue
```


```python
# 生成最终的回归树，树的后三个参数决定了树的类型，分别为给出建立叶节点的函数、计算误差的函数、设置树生成的一个控制阈值
def createtree(dataset, leaftype=regleaf, errtype=regerr, ops=(1,4)):
     # 返回最佳的切分特征和最佳的切分特征值
    feat, val = chooseBestSplit(dataset,leaftype, errtype, ops)
    if feat == None:return val
    rettree = {}
    rettree['spind'] = feat
    rettree['spval'] = val
    lset, rset = binsplitdataset(dataset, feat, val)
    # 这里是递归调用本函数
    rettree['left'] = createtree(lset, leaftype, errtype, ops)
    rettree['right'] = createtree(rset, leaftype, errtype, ops)
    return rettree
```


```python
myDat = loaddataset('D:\jupyter_notebook\machinelearninginaction\Ch09\ex00.txt')
```


```python
myMat = np.mat(myDat)
myMat
```




    matrix([[ 3.609800e-02,  1.550960e-01],
            [ 9.933490e-01,  1.077553e+00],
            [ 5.308970e-01,  8.934620e-01],
            [ 7.123860e-01,  5.648580e-01],
            [ 3.435540e-01, -3.717000e-01],
            [ 9.801600e-02, -3.327600e-01],
            [ 6.911150e-01,  8.343910e-01],
            [ 9.135800e-02,  9.993500e-02],
            [ 7.270980e-01,  1.000567e+00],
            [ 9.519490e-01,  9.452550e-01],
            [ 7.685960e-01,  7.602190e-01],
            [ 5.413140e-01,  8.937480e-01],
            [ 1.463660e-01,  3.428300e-02],
            [ 6.731950e-01,  9.150770e-01],
            [ 1.835100e-01,  1.848430e-01],
            [ 3.395630e-01,  2.067830e-01],
            [ 5.179210e-01,  1.493586e+00],
            [ 7.037550e-01,  1.101678e+00],
            [ 8.307000e-03,  6.997600e-02],
            [ 2.439090e-01, -2.946700e-02],
            [ 3.069640e-01, -1.773210e-01],
            [ 3.649200e-02,  4.081550e-01],
            [ 2.955110e-01,  2.882000e-03],
            [ 8.375220e-01,  1.229373e+00],
            [ 2.020540e-01, -8.774400e-02],
            [ 9.193840e-01,  1.029889e+00],
            [ 3.772010e-01, -2.435500e-01],
            [ 8.148250e-01,  1.095206e+00],
            [ 6.112700e-01,  9.820360e-01],
            [ 7.224300e-02, -4.209830e-01],
            [ 4.102300e-01,  3.317220e-01],
            [ 8.690770e-01,  1.114825e+00],
            [ 6.205990e-01,  1.334421e+00],
            [ 1.011490e-01,  6.883400e-02],
            [ 8.208020e-01,  1.325907e+00],
            [ 5.200440e-01,  9.619830e-01],
            [ 4.881300e-01, -9.779100e-02],
            [ 8.198230e-01,  8.352640e-01],
            [ 9.750220e-01,  6.735790e-01],
            [ 9.531120e-01,  1.064690e+00],
            [ 4.759760e-01, -1.637070e-01],
            [ 2.731470e-01, -4.552190e-01],
            [ 8.045860e-01,  9.240330e-01],
            [ 7.479500e-02, -3.496920e-01],
            [ 6.253360e-01,  6.236960e-01],
            [ 6.562180e-01,  9.585060e-01],
            [ 8.340780e-01,  1.010580e+00],
            [ 7.819300e-01,  1.074488e+00],
            [ 9.849000e-03,  5.659400e-02],
            [ 3.022170e-01, -1.486500e-01],
            [ 6.782870e-01,  9.077270e-01],
            [ 1.805060e-01,  1.036760e-01],
            [ 1.936410e-01, -3.275890e-01],
            [ 3.434790e-01,  1.752640e-01],
            [ 1.458090e-01,  1.369790e-01],
            [ 9.967570e-01,  1.035533e+00],
            [ 5.902100e-01,  1.336661e+00],
            [ 2.380700e-01, -3.584590e-01],
            [ 5.613620e-01,  1.070529e+00],
            [ 3.775970e-01,  8.850500e-02],
            [ 9.914200e-02,  2.528000e-02],
            [ 5.395580e-01,  1.053846e+00],
            [ 7.902400e-01,  5.332140e-01],
            [ 2.422040e-01,  2.093590e-01],
            [ 1.523240e-01,  1.328580e-01],
            [ 2.526490e-01, -5.561300e-02],
            [ 8.959300e-01,  1.077275e+00],
            [ 1.333000e-01, -2.231430e-01],
            [ 5.597630e-01,  1.253151e+00],
            [ 6.436650e-01,  1.024241e+00],
            [ 8.772410e-01,  7.970050e-01],
            [ 6.137650e-01,  1.621091e+00],
            [ 6.457620e-01,  1.026886e+00],
            [ 6.513760e-01,  1.315384e+00],
            [ 6.977180e-01,  1.212434e+00],
            [ 7.425270e-01,  1.087056e+00],
            [ 9.010560e-01,  1.055900e+00],
            [ 3.623140e-01, -5.564640e-01],
            [ 9.482680e-01,  6.318620e-01],
            [ 2.340000e-04,  6.090300e-02],
            [ 7.500780e-01,  9.062910e-01],
            [ 3.254120e-01, -2.192450e-01],
            [ 7.268280e-01,  1.017112e+00],
            [ 3.480130e-01,  4.893900e-02],
            [ 4.581210e-01, -6.145600e-02],
            [ 2.807380e-01, -2.288800e-01],
            [ 5.677040e-01,  9.690580e-01],
            [ 7.509180e-01,  7.481040e-01],
            [ 5.758050e-01,  8.990900e-01],
            [ 5.079400e-01,  1.107265e+00],
            [ 7.176900e-02, -1.109460e-01],
            [ 5.535200e-01,  1.391273e+00],
            [ 4.011520e-01, -1.216400e-01],
            [ 4.066490e-01, -3.663170e-01],
            [ 6.521210e-01,  1.004346e+00],
            [ 3.478370e-01, -1.534050e-01],
            [ 8.193100e-02, -2.697560e-01],
            [ 8.216480e-01,  1.280895e+00],
            [ 4.801400e-02,  6.449600e-02],
            [ 1.309620e-01,  1.842410e-01],
            [ 7.734220e-01,  1.125943e+00],
            [ 7.896250e-01,  5.526140e-01],
            [ 9.699400e-02,  2.271670e-01],
            [ 6.257910e-01,  1.244731e+00],
            [ 5.895750e-01,  1.185812e+00],
            [ 3.231810e-01,  1.808110e-01],
            [ 8.224430e-01,  1.086648e+00],
            [ 3.603230e-01, -2.048300e-01],
            [ 9.501530e-01,  1.022906e+00],
            [ 5.275050e-01,  8.795600e-01],
            [ 8.600490e-01,  7.174900e-01],
            [ 7.044000e-03,  9.415000e-02],
            [ 4.383670e-01,  3.401400e-02],
            [ 5.745730e-01,  1.066130e+00],
            [ 5.366890e-01,  8.672840e-01],
            [ 7.821670e-01,  8.860490e-01],
            [ 9.898880e-01,  7.442070e-01],
            [ 7.614740e-01,  1.058262e+00],
            [ 9.854250e-01,  1.227946e+00],
            [ 1.325430e-01, -3.293720e-01],
            [ 3.469860e-01, -1.503890e-01],
            [ 7.687840e-01,  8.997050e-01],
            [ 8.489210e-01,  1.170959e+00],
            [ 4.492800e-01,  6.909800e-02],
            [ 6.617200e-02,  5.243900e-02],
            [ 8.137190e-01,  7.066010e-01],
            [ 6.619230e-01,  7.670400e-01],
            [ 5.294910e-01,  1.022206e+00],
            [ 8.464550e-01,  7.200300e-01],
            [ 4.486560e-01,  2.697400e-02],
            [ 7.950720e-01,  9.657210e-01],
            [ 1.181560e-01, -7.740900e-02],
            [ 8.424800e-02, -1.954700e-02],
            [ 8.458150e-01,  9.526170e-01],
            [ 5.769460e-01,  1.234129e+00],
            [ 7.720830e-01,  1.299018e+00],
            [ 6.966480e-01,  8.454230e-01],
            [ 5.950120e-01,  1.213435e+00],
            [ 6.486750e-01,  1.287407e+00],
            [ 8.970940e-01,  1.240209e+00],
            [ 5.529900e-01,  1.036158e+00],
            [ 3.329820e-01,  2.100840e-01],
            [ 6.561500e-02, -3.069700e-01],
            [ 2.786610e-01,  2.536280e-01],
            [ 7.731680e-01,  1.140917e+00],
            [ 2.036930e-01, -6.403600e-02],
            [ 3.556880e-01, -1.193990e-01],
            [ 9.888520e-01,  1.069062e+00],
            [ 5.187350e-01,  1.037179e+00],
            [ 5.145630e-01,  1.156648e+00],
            [ 9.764140e-01,  8.629110e-01],
            [ 9.190740e-01,  1.123413e+00],
            [ 6.977770e-01,  8.278050e-01],
            [ 9.280970e-01,  8.832250e-01],
            [ 9.002720e-01,  9.968710e-01],
            [ 3.441020e-01, -6.153900e-02],
            [ 1.480490e-01,  2.042980e-01],
            [ 1.300520e-01, -2.616700e-02],
            [ 3.020010e-01,  3.171350e-01],
            [ 3.371000e-01,  2.633200e-02],
            [ 3.149240e-01, -1.952000e-03],
            [ 2.696810e-01, -1.659710e-01],
            [ 1.960050e-01, -4.884700e-02],
            [ 1.290610e-01,  3.051070e-01],
            [ 9.367830e-01,  1.026258e+00],
            [ 3.055400e-01, -1.159910e-01],
            [ 6.839210e-01,  1.414382e+00],
            [ 6.223980e-01,  7.663300e-01],
            [ 9.025320e-01,  8.616010e-01],
            [ 7.125030e-01,  9.334900e-01],
            [ 5.900620e-01,  7.055310e-01],
            [ 7.231200e-01,  1.307248e+00],
            [ 1.882180e-01,  1.136850e-01],
            [ 6.436010e-01,  7.825520e-01],
            [ 5.202070e-01,  1.209557e+00],
            [ 2.331150e-01, -3.481470e-01],
            [ 4.656250e-01, -1.529400e-01],
            [ 8.845120e-01,  1.117833e+00],
            [ 6.632000e-01,  7.016340e-01],
            [ 2.688570e-01,  7.344700e-02],
            [ 7.292340e-01,  9.319560e-01],
            [ 4.296640e-01, -1.886590e-01],
            [ 7.371890e-01,  1.200781e+00],
            [ 3.785950e-01, -2.960940e-01],
            [ 9.301730e-01,  1.035645e+00],
            [ 7.743010e-01,  8.367630e-01],
            [ 2.739400e-01, -8.571300e-02],
            [ 8.244420e-01,  1.082153e+00],
            [ 6.260110e-01,  8.405440e-01],
            [ 6.793900e-01,  1.307217e+00],
            [ 5.782520e-01,  9.218850e-01],
            [ 7.855410e-01,  1.165296e+00],
            [ 5.974090e-01,  9.747700e-01],
            [ 1.408300e-02, -1.325250e-01],
            [ 6.638700e-01,  1.187129e+00],
            [ 5.523810e-01,  1.369630e+00],
            [ 6.838860e-01,  9.999850e-01],
            [ 2.103340e-01, -6.899000e-03],
            [ 6.045290e-01,  1.212685e+00],
            [ 2.507440e-01,  4.629700e-02]])




```python
createtree(myMat)
```




    {'spind': 0,
     'spval': 0.48813,
     'left': 1.0180967672413792,
     'right': -0.04465028571428572}




```python
import matplotlib.pyplot as plt 
myDat=loaddataset('D:\jupyter_notebook\machinelearninginaction\Ch09\ex00.txt')
myMat=np.mat(myDat) 
createtree(myMat) 
plt.plot(myMat[:,0],myMat[:,1],'ro') 
plt.show()
```






```python
myDat1 = np.mat(loaddataset('D:\jupyter_notebook\machinelearninginaction\Ch09\ex0.txt'))
createtree(myDat1)
```




    {'spind': 1,
     'spval': 0.39435,
     'left': {'spind': 1,
      'spval': 0.582002,
      'left': {'spind': 1,
       'spval': 0.797583,
       'left': 3.9871632,
       'right': 2.9836209534883724},
      'right': 1.980035071428571},
     'right': {'spind': 1,
      'spval': 0.197834,
      'left': 1.0289583666666666,
      'right': -0.023838155555555553}}




```python
import matplotlib.pyplot as plt 
myDat1 = np.mat(loaddataset('D:\jupyter_notebook\machinelearninginaction\Ch09\ex0.txt'))
myMat1=np.mat(myDat1) 
createtree(myMat1) 
plt.plot(myMat1[:,1],myMat1[:,2],'ro') 
plt.show()

```



```python

```
